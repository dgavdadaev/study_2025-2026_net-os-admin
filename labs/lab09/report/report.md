---
## Front matter
title: "Отчёт по лабораторной работе 9"
subtitle: "Настройка POP3/IMAP сервера"
author: "Авдадаев Джамал Геланиевич"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Введение

## Цель работы  

Приобретение практических навыков по установке и простейшему конфигурированию POP3/IMAP-сервера.

# Процесс работы

## Установка и базовая настройка Dovecot

На виртуальной машине `server` выполнена установка и настройка почтового сервера Dovecot. После перехода в режим суперпользователя произведена установка необходимых пакетов. Процесс завершился успешно, что подтверждается выводом терминала.

![Установка пакетов dovecot и telnet](Screenshot_1.png){ #fig:001 width=80% }

## Настройка Dovecot

### Настройка списка поддерживаемых протоколов

В конфигурационном файле `/etc/dovecot/dovecot.conf` указан список почтовых протоколов, которые разрешены для использования службой Dovecot. Активированы протоколы IMAP и POP3.

![Настройка протоколов в dovecot.conf](Screenshot_2.png){ #fig:002 width=80% }

### Настройка метода аутентификации

В параметрах файла `/etc/dovecot/conf.d/10-auth.conf` подтверждено использование механизма аутентификации `plain`. Этот вариант обеспечивает базовый метод проверки пользователя.

![Метод аутентификации в 10-auth.conf](Screenshot_3.png){ #fig:003 width=80% }

### Настройка источников данных пользователей

В конфигурационном файле `/etc/dovecot/conf.d/auth-system.conf.ext` указано использование PAM для проверки паролей и системного файла `passwd` для получения информации о пользователях. Такая схема позволяет службе аутентификации обращаться к данным системы.

![Настройка passdb и userdb](Screenshot_4.png){ #fig:004 width=80% }

### Настройка расположения почтовых ящиков

В файле `/etc/dovecot/conf.d/10-mail.conf` определено месторасположение почтовых ящиков пользователя в формате Maildir, размещённом в домашнем каталоге.

![Настройка mail_location в 10-mail.conf](Screenshot_5.png){ #fig:005 width=80% }

### Настройка Postfix

Для корректной доставки почты Postfix настроен на использование каталога Maildir в качестве хранилища почты пользователя. Это обеспечивает совместимость серверов и корректную доставку писем.

### Настройка межсетевого экрана FirewallD

Для функционирования POP3, POP3S, IMAP и IMAPS службы данных протоколов были добавлены в правила межсетевого экрана. После обновления конфигурации выполнена перезагрузка правил и проверка списка активных сервисов.

![Настройка firewall для POP3/IMAP](Screenshot_6.png){ #fig:006 width=90% }

### Восстановление контекста SELinux

Безопасность системы усилена восстановлением корректных SELinux-контекстов для каталога `/etc`. Это обеспечивает корректную работу почтовых сервисов, взаимодействующих с системными файлами.

### Запуск служб

По завершении конфигурации произведён перезапуск Postfix и запуск Dovecot. Служба Dovecot также добавлена в автозагрузку, что гарантирует её активацию при запуске системы.

## Проверка работы Dovecot

Для анализа корректности функционирования почтовой подсистемы были выполнены последовательные проверки с использованием локальных средств системы, почтового клиента и telnet-подключения.

На сервере был запущен просмотр журнала почтовой службы в реальном времени. Это позволило наблюдать появление записей при доставке писем, их получении через IMAP и POP3, а также при обращении почтового клиента.

### Настройка и проверка работы почтового клиента Evolution

На клиентской виртуальной машине был установлен и настроен почтовый клиент Evolution.  
При создании учётной записи указаны:

- адрес вида `user@user.net`,  
- IMAP-сервер и SMTP-сервер — `mail.user.net`,  
- порты: IMAP — 143, SMTP — 25,  
- типы шифрования — STARTTLS для IMAP, отсутствие шифрования для SMTP,  
- вход по обычному паролю.

После сохранения настроек была выполнена отправка тестового письма самому себе:

![Отправка тестового письма](Screenshot_7.png){ #fig:007 width=80% }

Письмо успешно доставлено и появилось в ящике:

![Получение письма в Evolution](Screenshot_8.png){ #fig:008 width=90% }

### Анализ журнала почтовой службы

Во время отправки и получения писем в журнале `maillog` зафиксирована информация о передаче сообщений, работе Postfix и успешной аутентификации Dovecot:

![Вывод почтового журнала](Screenshot_9.png){ #fig:009 width=90% }

Эти записи подтверждают корректную обработку входящих и исходящих сообщений, а также успешное выполнение IMAP-логина.

Через встроенную консольную утилиту был выполнен просмотр содержимого каталога Maildir. В списке отображаются сообщения, доставленные пользователю:

![Просмотр почты через mail](Screenshot_10.png){ #fig:010 width=80% }

### Проверка работы POP3 через Telnet

Для тестирования протокола POP3 выполнено соединение через telnet:

- выполнен вход под логином и паролем пользователя,
- получен список писем,
- считано содержимое первого письма,
- второе письмо удалено,
- соединение корректно завершено.

![Работа через telnet по POP3](Screenshot_11.png){ #fig:011 width=90% }

Это подтверждает корректность работы Dovecot по протоколу POP3.

## Внесение изменений во внутреннее окружение виртуальной машины

В каталоге `/vagrant/provision/server/mail` были созданы необходимые подкаталоги, и в них перенесены конфигурации Dovecot:

![Копирование конфигурационных файлов](Screenshot_12.png){ #fig:012 width=90% }

В файл `/vagrant/provision/server/mail.sh` были добавлены строки:

- об установке Dovecot и Telnet,
- о настройке межсетевого экрана,
- о настройке Postfix (в т. ч. параметра Maildir),
- о перезапуске Postfix и запуске Dovecot.

![Обновлённый сценарий mail.sh](Screenshot_13.png){ #fig:013 width=80% }

В файле `/vagrant/provision/client/mail.sh` была добавлена строка установки Evolution:

![Сценарий клиента](Screenshot_14.png){ #fig:014 width=80% }

# Итоги

## Вывод  
В ходе выполнения лабораторной работы была развёрнута и настроена почтовая подсистема на основе Postfix и Dovecot. Настроены протоколы IMAP и POP3, создан и сконфигурирован почтовый клиент Evolution, выполнена отправка и получение тестовых сообщений. Дополнительно проведена проверка работы службы через консольные инструменты `mail`, `doveadm` и Telnet. Конфигурационные файлы были сохранены во внутреннее окружение Vagrant, а provisioning-скрипты дополнены автоматизацией всей почтовой настройки. Почтовая служба функционирует корректно.

## Контрольные вопросы

**1. За что отвечает протокол SMTP?**  
SMTP используется для отправки электронной почты. Он управляет передачей сообщений от клиента к серверу и между почтовыми серверами.

**2. За что отвечает протокол IMAP?**  
IMAP обеспечивает доступ к почтовому ящику на сервере с возможностью синхронизации состояния сообщений между всеми клиентскими устройствами.

**3. За что отвечает протокол POP3?**  
POP3 используется для получения почты с сервера. Чаще всего письма скачиваются на клиент и удаляются с сервера, что исключает их синхронизацию между устройствами.

**4. В чём назначение Dovecot?**  
Dovecot — это почтовый сервер, обеспечивающий работу протоколов IMAP и POP3, а также аутентификацию пользователей и доступ к их почтовым ящикам.

**5. В каких файлах обычно находятся настройки работы Dovecot? За что отвечает каждый?**  
Основные файлы конфигурации:
- `dovecot.conf` — общие настройки службы и список активных протоколов.  
- `conf.d/10-auth.conf` — параметры аутентификации и допустимые механизмы логина.  
- `conf.d/auth-system.conf.ext` — описание источников данных о пользователях (pam, passwd и др.).  
- `conf.d/10-mail.conf` — настройки месторасположения почтовых ящиков (Maildir, mbox).  

**6. В чём назначение Postfix?**  
Postfix обеспечивает обработку, маршрутизацию и доставку электронных писем, работая как SMTP-сервер.

**7. Какие методы аутентификации можно использовать в Dovecot и в чём их отличие?**  
- `plain`, `login` — передают пароль в виде открытого текста (часто с TLS).  
- `digest-md5`, `cram-md5` — используют хеширование и не передают пароль напрямую.  
- `oauth2`, `gssapi` — современные механизмы для корпоративных систем и единой авторизации.  
Отличия заключаются в уровне безопасности и совместимости с клиентскими приложениями.

**8. Пример заголовка письма с пояснениями:**  
- `From:` — отправитель письма.  
- `To:` — получатель.  
- `Subject:` — тема сообщения.  
- `Date:` — дата и время отправки.  
- `Message-ID:` — уникальный идентификатор письма.  
- `Received:` — цепочка серверов, через которые проходило сообщение.

**9. Примеры команд работы с почтовыми протоколами через telnet:**  
- `telnet mail.user.net 110` — подключение к POP3.  
- `user имя` — ввод имени пользователя.  
- `pass пароль` — ввод пароля.  
- `list` — список писем.  
- `retr 1` — получение первого письма.  
- `dele 1` — удаление письма.  
- `quit` — завершение работы.

**10. Примеры работы с doveadm:**  
- `doveadm mailbox list -u user` — список почтовых папок пользователя.  
- `doveadm fetch -u user hdr Subject inbox` — получить темы сообщений из INBOX.  
- `doveadm expunge -u user mailbox inbox before 7d` — удалить старые письма.  
- `doveadm pw -s SHA512-CRYPT` — создание хэша пароля.

