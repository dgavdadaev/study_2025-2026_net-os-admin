---
## Front matter
title: "Отчёт по лабораторной работе 11"
subtitle: "Настройка безопасного удалённого доступа по протоколу SSH"
author: "Авдадаев Джамал Геланиевич"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Введение

## Цель работы  

Приобретение практических навыков по настройке удалённого доступа к серверу с помощью SSH.

# Процесс работы

## Запрет удалённого доступа по SSH для пользователя root

### Попытка подключения по SSH под пользователем root

С клиента была выполнена попытка подключения к серверу через SSH под пользователем *root*.  
SSH запросил подтверждение ключа сервера, после чего несколько попыток ввода пароля завершились неудачно.  
Аутентификация была отклонена — вход под root не был разрешён.

![Неуспешная попытка подключения под root](Screenshot_1.png){ #fig:001 width=80% }

### Изменение конфигурации SSH для запрета root-доступа

На сервере был открыт файл конфигурации `/etc/ssh/sshd_config`, где параметр:

```
PermitRootLogin no
```

запрещает удалённый вход для пользователя root.

![Файл sshd_config — запрет root](Screenshot_2.png){ #fig:002 width=80% }

После выполнения перезапуска службы SSH изменения вступили в силу.

### Повторная попытка подключения под root

После перезапуска SSH-сервера повторная попытка подключения под root вновь завершается отказом.  
Теперь это ожидаемое поведение, так как вход root официально запрещён в конфигурации SSH.

![Отказ в доступе после запрета PermitRootLogin](Screenshot_3.png){ #fig:003 width=80% }

## Ограничение списка пользователей для удалённого доступа по SSH

### Попытка подключения под обычным пользователем

Пользователь *dgavdadaev* успешно подключился по SSH к серверу.  
Аутентификация выполнена успешно, доступ предоставлен.

![Успешный вход пользователя dgavdadaev](Screenshot_4.png){ #fig:004 width=80% }

### Добавление ограничения AllowUsers

В файл `/etc/ssh/sshd_config` добавлена строка:

```
AllowUsers vagrant
```

Это ограничивает вход только для пользователя *vagrant*.

![Файл sshd_config — AllowUsers vagrant](Screenshot_5.png){ #fig:005 width=80% }

После перезапуска sshd изменения вступили в силу.

### Повторная попытка подключения под пользователем dgavdadaev

После добавления ограничения пользователь *dgavdadaev* больше не может войти в систему.  
Попытки входа завершаются сообщением об отказе в доступе.

![Отказ из-за AllowUsers](Screenshot_6.png){ #fig:006 width=80% }

### Расширение списка AllowUsers

В конфигурацию было добавлено расширение списка разрешённых пользователей:

```
AllowUsers vagrant dgavdadaev
```

![Файл sshd_config — добавление второго пользователя](Screenshot_7.png){ #fig:007 width=80% }

После перезапуска sshd пользователь вновь получил возможность подключаться.

![Успешный вход после добавления пользователя в AllowUsers](Screenshot_8.png){ #fig:008 width=80% }

## Настройка дополнительных портов для удалённого доступа по SSH

### Добавление второго SSH-порта

В конфигурационном файле `/etc/ssh/sshd_config` была найдена строка `Port` и ниже добавлены два порта:

```
Port 22
Port 2022
```

Это позволяет одновременно слушать стандартный порт SSH и дополнительный, чтобы избежать полной потери доступа при ошибке в настройках.

![Добавление порта 2022](Screenshot_9.png){ #fig:009 width=80% }

После сохранения изменений служба SSH была перезапущена.

### Ошибка SELinux при запуске sshd

После перезапуска расширенный статус `systemctl status sshd` показал ошибку:

sshd не смог привязаться к порту 2022, так как SELinux запрещал использование этого порта для сервиса ssh.

Системные сообщения:

- *Bind to port 2022 failed: Permission denied*
- SELinux блокирует назначение нестандартного порта SSH.

![Ошибка привязки к порту 2022](Screenshot_10.png){ #fig:010 width=80% }

### Исправление SELinux и настройка firewall

Для разрешения использования порта 2022 был выполнен ввод метки SELinux:

```
semanage port -a -t ssh_port_t -p tcp 2022
```

Затем в firewall открыт новый порт:

```
firewall-cmd --add-port=2022/tcp
firewall-cmd --add-port=2022/tcp --permanent
```

После перезапуска sshd статус показал, что сервер теперь прослушивает оба порта — 22 и 2022.

![Успешное добавление порта SELinux и firewall](Screenshot_11.png){ #fig:011 width=80% }

### Проверка подключения через порт 22

Была выполнена команда подключения:

```
ssh [dgavdadaev@server.dgavdadaev.net](mailto:dgavdadaev@server.dgavdadaev.net)
```

Вход выполнен успешно, а затем через `sudo -i` получен доступ root.  
После выхода из обоих сеансов соединение закрыто.

### Подключение через порт 2022

Далее была выполнена проверка альтернативного порта:

```
ssh -p2022 [dgavdadaev@server.dgavdadaev.net](mailto:dgavdadaev@server.dgavdadaev.net)
```

Вход снова прошёл успешно.  
Поведение идентично предыдущему — SSH корректно работает через новый порт.

![Подключение по порту 2022](Screenshot_12.png){ #fig:012 width=80% }

## Настройка удалённого доступа по SSH с использованием ключей

### Разрешение аутентификации по ключу

В конфигурационный файл SSH добавлен параметр:

```
PubkeyAuthentication yes
```

![Параметр PubkeyAuthentication](Screenshot_13.png){ #fig:013 width=80% }

После внесения изменений sshd перезапущен.

### Создание пары ключей на клиенте

Под пользователем *dgavdadaev* выполнено создание ключей:

```
ssh-keygen
```

При всех запросах подтверждений использованы настройки по умолчанию.  
В результате:

- закрытый ключ сохранён в `~/.ssh/id_rsa`
- открытый ключ — в `~/.ssh/id_rsa.pub`

### Копирование ключа на сервер

Открытый ключ передан на сервер командой:

```
ssh-copy-id [dgavdadaev@server.dgavdadaev.net](mailto:dgavdadaev@server.dgavdadaev.net)
```

После ввода пароля ключ был добавлен в `~/.ssh/authorized_keys` на сервере.

### Подключение по SSH без пароля

Повторное подключение:

```
ssh [dgavdadaev@server.dgavdadaev.net](mailto:dgavdadaev@server.dgavdadaev.net)
```

Теперь вход выполняется без запроса пароля, что подтверждает успешную настройку SSH-доступа по ключу.

После завершения работы выполнен выход с сервера с использованием `Ctrl + d`.

![Подключение по SSH без пароля](Screenshot_14.png){ #fig:014 width=80% }

## Организация туннелей SSH и перенаправление TCP-портов

### Просмотр TCP-служб на клиенте

На клиенте был выполнен просмотр активных процессов, использующих TCP.  
На момент проверки никаких дополнительных служб не было запущено.

### Создание SSH-туннеля для перенаправления порта

Было выполнено локальное перенаправление:

```
8080 → server:80
```

Команда открыла SSH-соединение и создала сокет, который принимает запросы на локальный порт 8080 и пересылает их на порт 80 сервера.

После создания туннеля повторная команда `lsof | grep TCP` показала новые записи:

- локальный процесс SSH слушает порт `localhost:webcache`
- активное TCP-соединение между клиентом и сервером
- перенаправленный сокет (LISTEN)

![Появление новых TCP соединений после создания туннеля](Screenshot_15.png){ #fig:015 width=80% }

Это подтверждает, что порт-форвардинг активен.

### Проверка работы перенаправленного порта

В браузере на клиенте открыт адрес:

```
[http://localhost:8080](http://localhost:8080)
```

Страница успешно открылась, что означает корректную передачу трафика на веб-сервер удалённой машины.

![Переход на localhost:8080 — отображение страницы сервера](Screenshot_16.png){ #fig:016 width=80% }

## Запуск консольных приложений через SSH

### Просмотр имени узла сервера

Удалённая команда:

```
ssh [dgavdadaev@server.dgavdadaev.net](mailto:dgavdadaev@server.dgavdadaev.net) hostname
```

вернула имя сервера.

### Просмотр файлов на сервере

Команда:

```
ssh [dgavdadaev@server.dgavdadaev.net](mailto:dgavdadaev@server.dgavdadaev.net) ls -Al
```

отобразила содержимое домашнего каталога пользователя.

![Удалённый просмотр файлов](Screenshot_17.png){ #fig:017 width=80% }

### Просмотр почты пользователя

Команда:

```
ssh [dgavdadaev@server.dgavdadaev.net](mailto:dgavdadaev@server.dgavdadaev.net) MAIL=~/Maildir mail
```

открыла консольный почтовый клиент и показала полученные сообщения.

![Просмотр почты через SSH](Screenshot_18.png){ #fig:018 width=80% }

## Запуск графических приложений по SSH (X11Forwarding)

### Разрешение X11-переадресации на сервере

В файл `/etc/ssh/sshd_config` была добавлена строка:

```
X11Forwarding yes
```

Это разрешает пересылку X11-графики на клиентскую машину.

![Разрешение X11Forwarding](Screenshot_19.png){ #fig:019 width=80% }

После перезапуска sshd была предпринята попытка запуска Firefox по SSH:

```
ssh -YC [dgavdadaev@server.dgavdadaev.net](mailto:dgavdadaev@server.dgavdadaev.net) firefox
```

Однако запуск завершился ошибкой:

- отсутствует переменная DISPLAY на клиенте  
- fake X-auth не может создать контекст  
- пересылка X11 была отклонена сервером

Вывод:

- пересылка X11 настроена на сервере, но отсутствует полноценная X-среда в клиентской системе (например, Xorg, xauth или Wayland-X11 мост), поэтому графика не может быть отображена.

![Ошибка запуска графического приложения](Screenshot_20.png){ #fig:020 width=80% }


## Внесение изменений в настройки внутреннего окружения виртуальной машины

В каталоге `/vagrant/provision/server/` был создан каталог с конфигурацией SSH и подготовлен скрипт автоматизации.

### Создание структуры каталогов и копирование конфигурации

```
mkdir -p /vagrant/provision/server/ssh/etc/ssh
cp -R /etc/ssh/sshd_config /vagrant/provision/server/ssh/etc/ssh/
```

### Создание исполняемого файла `ssh.sh`

Скрипт был создан и сделан исполняемым.

Его содержимое:

![Содержимое файла ssh.sh](Screenshot_21.png){ #fig:021 width=80% }

Скрипт выполняет:

- копирование SSH-конфигурации внутрь Vagrant-окружения  
- настройку firewall  
- настройку SELinux  
- перезапуск sshd  

# Итоги

## Вывод  

В ходе работы были настроены параметры SSH-доступа: запрещён вход root, разрешён вход выбранным пользователям, добавлены дополнительные порты и исправлены политики SELinux и firewall. Проверена работа SSH-туннелей, локальной переадресации портов, консольных команд и почтового клиента. Попытка запуска графических приложений выявила отсутствие X-среды на клиенте. Созданы и настроены файлы окружения Vagrant для автоматизации конфигурации SSH. Все задачи выполнены, доступ и инструменты работают корректно.

## Контрольные вопросы  

**1. Вы хотите запретить удалённый доступ по SSH пользователю root и разрешить доступ пользователю alice. Как это сделать?**  
В конфигурации SSH (`/etc/ssh/sshd_config`) необходимо:  
- запретить вход root, установив `PermitRootLogin no`;  
- ограничить список пользователей строкой `AllowUsers alice`.  
После изменения файла требуется перезапустить службу sshd. В результате вход root будет заблокирован, а пользователь alice сможет подключаться.

**2. Как настроить удалённый доступ по SSH через несколько портов? Для чего это может потребоваться?**  
В файле `/etc/ssh/sshd_config` нужно указать несколько строк `Port`, например:  

```
Port 22
Port 2022
```
После перезапуска sshd сервер будет принимать подключения на обоих портах.  
Это позволяет сохранить доступ к серверу в случае ошибки в настройках или при необходимости изменить стандартный порт для повышения безопасности.

**3. Какие параметры используются для создания SSH-туннеля, когда ssh работает в фоне и не ожидает ввода команд?**  
Используются параметры:  
- `-f` — перевести процесс в фоновый режим;  
- `-N` — не выполнять удалённые команды;  
- `-L` — настроить локальное перенаправление порта.  
Такая комбинация позволяет создать устойчивый туннель без открытия удалённой оболочки.

**4. Как настроить локальную переадресацию с локального порта 5555 на порт 80 сервера server2.example.com?**  
Используется локальный форвардинг:  

```
ssh -fNL 5555:localhost:80 [user@server2.example.com](mailto:user@server2.example.com)
```
После выполнения команда создаёт туннель, через который обращения к `localhost:5555` пересылаются на порт 80 сервера.

**5. Как настроить SELinux, чтобы позволить SSH связываться с портом 2022?**  
Необходимо добавить порт в тип ssh_port_t:  

```
semanage port -a -t ssh_port_t -p tcp 2022
```
После добавления SELinux разрешит sshd использовать альтернативный порт.

**6. Как настроить межсетевой экран на сервере, чтобы разрешить входящие подключения по SSH через порт 2022?**  
Команды для firewalld:  

```
firewall-cmd --add-port=2022/tcp
firewall-cmd --add-port=2022/tcp --permanent
```
После перезапуска правил firewall новый порт становится доступным для входящих SSH-соединений.
