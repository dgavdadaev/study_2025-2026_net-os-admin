---
## Front matter
title: "Отчёт по лабораторной работе 8"
subtitle: "Настройка SMTP-сервера"
author: "Авдадаев Джамал Геланиевич"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Введение

## Цель работы  

Приобретение практических навыков по установке и конфигурированию SMTPсервера.

# Процесс работы

## Установка и базовая настройка Postfix на сервере

На виртуальной машине `server` была выполнена установка необходимых пакетов и первичная настройка службы Postfix. После перехода в режим суперпользователя были установлены Postfix и s-nail, разрешён SMTP-трафик в межсетевом экране, восстановлены SELinux-контексты и запущена служба Postfix.

Фрагмент процесса установки и настройки показан на скриншоте:

![Установка Postfix и настройка firewall](Screenshot_1.png){ #fig:001 width=80% }

### Изменение параметров Postfix с помощью postconf

Далее была выполнена первичная конфигурация Postfix. Определены текущие значения параметров `myorigin` и `mydomain`, после чего параметр `myorigin` был заменён на значение домена пользователя. Конфигурация была проверена и перечитана. Затем был отключён IPv6, оставлен только IPv4.

Результат изменения параметров и обновления конфигурации показан на скриншоте:

![Изменение параметров myorigin и mydomain](Screenshot_2.png){ #fig:002 width=80% }

![Изменение параметров myorigin и mydomain](Screenshot_3.png){ #fig:003 width=80% }

### Проверка работы Postfix на сервере

Пользователь отправил тестовое письмо самому себе при помощи утилиты почтовой отправки. В результате мониторинг лога почтовой службы показал успешную доставку сообщения. В каталоге `/var/spool/mail` появился файл почтового ящика пользователя, подтверждающий корректную работу системы.

Фрагмент работы службы приведён на скриншоте:

![Мониторинг лога и отправка локального письма](Screenshot_4.png){ #fig:004 width=80% }

![Мониторинг лога и отправка локального письма](Screenshot_5.png){ #fig:005 width=80% }

### Настройка Postfix на клиенте

На виртуальной машине `client` также были установлены Postfix и s-nail. После отключения IPv6 и запуска службы конфигурация была успешно активирована, что видно на скриншоте:

![Установка Postfix и настройка IPv4 на клиенте](Screenshot_6.png){ #fig:006 width=80% }

Сообщение, отправленное с клиента, было принято сервером и успешно доставлено в локальный почтовый ящик пользователя, что подтверждается логами почтовой службы на сервере:

### Расширение параметров сетевого доступа Postfix

Значения параметров `inet_interfaces` и `mynetworks` были просмотрены перед изменением. Затем Postfix был настроен на приём соединений со всех интерфейсов, а список доверенных сетей был расширен внутренней подсетью. После этого конфигурация была перезагружена и служба перезапущена.

Процесс настройки отображён на скриншоте:

![Настройка inet_interfaces и mynetworks](Screenshot_7.png){ #fig:007 width=80% }

### Повторная отправка письма с клиента

После внесения изменений в конфигурацию и перезапуска службы повторная отправка письма с клиента оказалась успешной. Сообщение было принято сервером и доставлено адресату, что подтверждено соответствующими строками журнала.

![Успешная доставка письма после настройки mynetworks](Screenshot_8.png){ #fig:008 width=80% }

## Конфигурация Postfix для домена

### Отправка письма на доменный адрес

С клиента было отправлено письмо на доменное имя пользователя. Почтовая служба сервера приняла сообщение, однако попытка доставки завершилась ошибкой из-за отсутствия корректной конфигурации DNS и MX-записей для домена. Содержимое полученного письма представлено на скриншоте:

![Полученное письмо с клиента перед настройкой MX](Screenshot_9.png){ #fig:009 width=80% }

Также была просмотрена очередь сообщений Postfix. Письмо оказалось в очереди с пометкой о невозможности доставки:

![Очередь сообщений Postfix при ошибке доставки](Screenshot_10.png){ #fig:010 width=80% }

Мониторинг журнала почтовой службы показал, что сервер не смог доставить письмо на доменный адрес. Логи отразили ошибку подключения либо возврат письма отправителю:

![Мониторинг maillog при ошибке доставки](Screenshot_11.png){ #fig:011 width=80% }

### Настройка MX-записей для домена

Для корректной доставки почты была выполнена настройка прямой и обратной DNS-зоны.  
В файл прямой зоны была добавлена MX-запись, указывающая почтовый сервер `mail.user.net`.

Содержимое прямой зоны:

![Файл прямой DNS-зоны с MX-записью](Screenshot_12.png){ #fig:012 width=80% }

В файл обратной зоны добавлены соответствующие PTR-записи, указывающие имена узлов, включая почтовый сервер:

![Файл обратной DNS-зоны](Screenshot_13.png){ #fig:013 width=80% }

### Настройка Postfix для работы с доменом

После корректировки DNS зона была проверена, и затем в конфигурацию Postfix был добавлен домен пользователя в список конечных точек доставки (`mydestination`). Конфигурация была перезагружена, SELinux-контексты восстановлены, а служба named перезапущена.

После принудительной повторной попытки отправки сообщений из очереди (`postqueue -f`) доставка стала успешной.

Логи сервера подтверждают корректную доставку письма:

![Успешная доставка письма после настройки DNS и Postfix](Screenshot_14.png){ #fig:014 width=80% }

Полученное письмо на доменный адрес отображено на скриншоте:

![Полученное письмо test2 после настройки MX](Screenshot_15.png){ #fig:015 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальной машины

Для автоматизации конфигурации серверной части были подготовлены файлы для провижининга Vagrant.

В каталог `/vagrant/provision/server/dns/var/named` были перенесены файлы DNS-зон с сервера:

![Копирование конфигурации DNS в Vagrant provisioning](Screenshot_16.png){ #fig:016 width=80% }

В каталоге `/vagrant/provision/server` был создан исполняемый файл `mail.sh`, предназначенный для автоматизации настройки Postfix:

Первоначальный вариант сценария включал полный набор команд настройки:

![Полный вариант mail.sh](Screenshot_17.png){ #fig:017 width=80% }

Затем был создан сокращённый вариант, содержащий основные шаги конфигурации:

![Минимизированный вариант mail.sh](Screenshot_18.png){ #fig:018 width=80% }

# Итоги

## Вывод

В ходе выполнения работы была настроена почтовая система Postfix для локальной сети и доменной доставки. Выполнены базовая установка, изменение ключевых параметров конфигурации, настройка DNS-зон, а также проверка работы почтовых механизмов как на сервере, так и на клиентской машине. Реализована полноценная отправка писем на доменные адреса, настройка очереди сообщений и автоматизация конфигурации через provisioning-скрипты. Почтовая инфраструктура успешно функционирует в соответствии с заданием.

## Контрольные вопросы

**1. В каком каталоге и в каком файле следует смотреть конфигурацию Postfix?**
Основная конфигурация Postfix содержится в каталоге `/etc/postfix/` в файле `main.cf`.
Дополнительные параметры службы определяются в файле `master.cf` в том же каталоге.

**2. Каким образом можно проверить корректность синтаксиса в конфигурационном файле Postfix?**
Postfix предоставляет встроенный механизм проверки командой:
`postfix check`
Она анализирует корректность конфигурационных файлов и выводит сообщения об ошибках в журнал.

**3. В каких параметрах конфигурации Postfix требуется внести изменения для настройки возможности отправки писем не на локальный хост, а на доменные адреса?**
Для корректной доменной доставки изменяются:

* `myorigin` — домен отправителя;
* `mydomain` — доменное имя сервера;
* `mydestination` — список доменов, для которых сервер является конечной точкой доставки;
* `inet_interfaces` — сетевые интерфейсы, на которых слушает Postfix;
* `mynetworks` — подсеть, из которой разрешено отправлять почту;
* корректная MX-запись в DNS-зоне домена.

**4. Приведите примеры работы с утилитой mail по отправке письма, просмотру имеющихся писем, удалению письма.**

* Отправка письма:
  `echo . | mail -s "test" user@domain.net`
* Просмотр входящих сообщений:
  `mail`
* Чтение письма по номеру:
  `2` (если нужно открыть второе письмо)
* Удаление письма:
  `d 2` — удалить второе письмо
* Выход из программы:
  `q`

**5. Приведите примеры работы с утилитой postqueue. Как посмотреть очередь сообщений? Как определить число сообщений в очереди? Как отправить все сообщения, находящиеся в очереди? Как удалить письмо из очереди?**

* Просмотр очереди сообщений:
  `postqueue -p`
* Просмотр только количества сообщений:
  `postqueue -p | grep -c '^[A-F0-9]'`
* Принудительная отправка всех писем в очереди:
  `postqueue -f`
* Удаление письма по ID:
  `postsuper -d <ID>`
* Удаление всех писем в очереди:
  `postsuper -d ALL`
