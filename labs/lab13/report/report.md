---
## Front matter
title: "Отчёт по лабораторной работе 13"
subtitle: "Настройка NFS"
author: "Авдадаев Джамал Геланиевич"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Введение

## Цель работы  

Приобретение навыков настройки сервера NFS для удалённого доступа к ресурсам.

# Процесс работы

## Настройка сервера NFSv4

На сервере было установлено программное обеспечение для работы NFS. После завершения установки появились зависимости, необходимые для запуска RPC-служб.

Был создан каталог, который планировалось использовать как корневой для экспортируемого NFS-дерева.

В файл `/etc/exports` была добавлена строка, предоставляющая общий доступ ко каталогу только для чтения всем клиентам сети.

![Редактирование /etc/exports](Screenshot_1.png){ #fig:001 width=80% }

Для каталога был назначен контекст безопасности типа `nfs_t`, после чего изменения применены ко всей структуре.

Служба NFS была запущена и добавлена в автозагрузку.

В межсетевой экран была добавлена служба NFS для разрешения входящих запросов. После изменения конфигурации firewall был перезагружен.

![Настройка firewall для NFS](Screenshot_2.png){ #fig:002 width=80% }

После установки клиентского ПО NFS была выполнена проверка доступных экспортов сервера.

Команда просмотра экспортов опрашивает RPC-службу mountd на сервере. При первоначальном запросе ответ не был получен из-за ограничений межсетевого экрана, но после его настройки ресурсы стали доступны.

![Проверка showmount](Screenshot_4.png){ #fig:003 width=80% }

После остановки службы firewall клиент смог получить список экспортов без ограничений. Это произошло потому, что все порты RPC-служб стали доступны напрямую.

Межсетевой экран был запущен вновь для продолжения настройки.

На стороне сервера была выполнена проверка активных TCP- и UDP-подключений, в которых участвовали процессы NFS, mountd и rpcbind. Эти службы обеспечивают обработку запросов на подключение и монтирование.

![Список служб rpc](Screenshot_3.png){ #fig:004 width=80% }

После этого службы mountd и rpc-bind были добавлены в настройки межсетевого экрана, чтобы обеспечить корректную работу протокола NFSv4 через firewall.

## Монтирование NFS на клиенте

На клиентской машине был создан каталог для подключения удалённого ресурса. После этого NFS-дерево сервера было успешно подключено.

![Монтирование NFS](Screenshot_5.png){ #fig:005 width=80% }

В выводе информации о монтировании видно:

- удалённый ресурс подключён по протоколу NFSv4;
- используется транспорт TCP;
- версия NFS — 4.2;
- указаны параметры производительности и безопасности;
- отображаются адреса сервера и клиента.

Это подтверждает корректное монтирование удалённого каталога.

В конец файла `/etc/fstab` была добавлена строка, обеспечивающая автоматическое подключение ресурса при загрузке системы.

![Редактирование /etc/fstab](Screenshot_6.png){ #fig:006 width=80% }

- `server.dgavdadaev.net:/srv/nfs` — путь к удалённому NFS-каталогу;
- `/mnt/nfs` — локальная точка монтирования;
- `nfs` — тип файловой системы;
- `_netdev` — флаг, указывающий системе монтировать ресурс только после поднятия сетевых интерфейсов;
- завершающие нули отключают проверку файловой системы и резервное копирование.

Служба `remote-fs.target` была активна, что подтверждает работу механизма автоматического монтирования сетевых ресурсов.

После перезагрузки клиентской системы NFS-каталог был автоматически подключён.

![remote-fs.target активен](Screenshot_7.png){ #fig:007 width=80% }

## Подключение каталогов к дереву NFS

На сервере был создан каталог, предназначенный для публикации веб-контента через NFS. После его создания в него был подключён каталог веб-сервера с использованием механизма `bind`. Это позволило отобразить содержимое `/var/www` внутри структуры `/srv/nfs`.

Проверка содержимого директории `/srv/nfs` показала наличие каталога `www`, что подтверждает корректность операции.

После монтирования NFS-ресурса клиентская система корректно отображала каталог `www` внутри точки монтирования `/mnt/nfs`. Это подтверждало, что клиент получает структуру каталогов с сервера без ошибок.

В файл `/etc/exports` была добавлена строка, предоставляющая доступ к каталогу веб-сервера всем машинам подсети `192.168.0.0/16` с правом записи. После обновления конфигурации экспортов сервер повторно экспортировал каталоги.

![Запись в /etc/exports](Screenshot_8.png){ #fig:008 width=80% }

Чтобы обеспечить автоматическое подмонтирование каталога веб-сервера в структуру дерева NFS при запуске операционной системы, в конец файла `/etc/fstab` была добавлена строка с типом `bind`.

![Запись в /etc/fstab](Screenshot_9.png){ #fig:009 width=80% }

После обновления конфигурации каталоги были повторно экспортированы. Клиент после этого продолжал корректно видеть каталог `www` внутри своей точки монтирования `/mnt/nfs`.

![Команды экспорта и повторная проверка](Screenshot_10.png){ #fig:010 width=80% }

Финальная проверка на клиентской машине показала, что каталог `www` доступен и корректно отображён в дереве NFS, что подтверждает успешную настройку как bind-монтирования, так и экспорта каталога по сети.

![Просмотр каталога на клиенте](Screenshot_11.png){ #fig:011 width=80% }

## Подключение каталогов для работы пользователей

Под пользователем `dgavdadaev` в его домашнем каталоге был создан каталог `common` с правами доступа 700. Внутри каталога создан файл `dgavdadaev@server.txt`.

![Создание каталога common и файла](Screenshot_12.png){ #fig:012 width=80% }

Права доступа каталога и файлов ограничивают доступ только пользователю.

На сервере был подготовлен каталог для экспорта домашнего каталога пользователя:

![Добавление экспорта в /etc/exports](Screenshot_13.png){ #fig:013 width=80% }

В файл `/etc/fstab` была добавлена строка для автоматического bind-монтирования каталога пользователя в дерево NFS:

![Запись в /etc/fstab](Screenshot_14.png){ #fig:014 width=80% }

На сервере были созданы каталоги, выполнено bind-монтирование и обновлены экспорты:

![Выполнение команд экспорта](Screenshot_15.png){ #fig:015 width=80% }

На клиенте каталог пользователя корректно отображается внутри `/mnt/nfs/home/dgavdadaev/`.

В каталоге созданы файлы `dgavdadaev@client.txt` и `dgavdadaev@client.txt` от разных пользователей.

![Создание файлов на клиенте](Screenshot_16.png){ #fig:016 width=80% }

Права доступа позволяют пользователю `dgavdadaev` создавать и изменять файлы.  
При попытке перейти в каталог под root возникло ограничение доступа, что связано с правами 700:

После создания файлов на клиенте соответствующие изменения появились на сервере в каталоге пользователя:

![Отображение изменений на сервере](Screenshot_17.png){ #fig:018 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальных машин

В каталоге `/vagrant/provision/server/` был создан подкаталог `nfs/etc` и в него скопирован файл `/etc/exports`.

![Копирование конфигурационных файлов](Screenshot_18.png){ #fig:019 width=80% }

В каталоге `/vagrant/provision/server/` создан файл `nfs.sh`.  
Внутри файла прописан скрипт автоматической настройки NFS, включая:

- установку пакетов,
- копирование конфигурации,
- настройку SELinux,
- настройку firewall,
- подготовку каталогов `/srv/nfs/www`, `/srv/nfs/home/...`,
- bind-монтирование каталогов,
- добавление записей в `/etc/fstab`,
- запуск службы NFS.

![Содержание nfs.sh на сервере](Screenshot_19.png){ #fig:020 width=80% }

В каталоге `/vagrant/provision/client/` был создан исполняемый файл `nfs.sh`, предназначенный для автоматической настройки NFS-клиента, включая:

- установку пакетов NFS,
- создание точки монтирования,
- монтирование каталога,
- добавление записи в `/etc/fstab`,
- восстановление SELinux-контекстов.

![Содержание nfs.sh на клиенте](Screenshot_20.png){ #fig:021 width=80% }

# Итоги

## Вывод  
В ходе работы были настроены экспортируемые каталоги NFS, включая системные и пользовательские ресурсы. Реализовано bind-монтирование каталогов веб-сервера и домашнего каталога пользователя. На клиенте выполнена проверка доступа к удалённым ресурсам, обеспечена возможность создания файлов, а также изучено поведение при различных правах доступа. Кроме того, подготовлены provisioning-скрипты, автоматизирующие настройку NFS-сервера и клиента. Лабораторная работа успешно завершена, все пункты задания выполнены.

## Контрольные вопросы  

**1. Как называется файл конфигурации, содержащий общие ресурсы NFS?**  
Файл `/etc/exports`, в котором перечислены каталоги, доступные клиентам NFS, а также параметры их экспорта.

**2. Какие порты должны быть открыты в брандмауэре, чтобы обеспечить полный доступ к серверу NFS?**  
Необходимо открыть службы NFS, RPC-bind и mountd.  
Они используют следующие порты:  
- NFSv4 — TCP 2049  
- rpcbind — TCP/UDP 111  
- mountd — динамический порт (обычно задаётся в конфигурации или открывается как сервис в firewall)

**3. Какую опцию следует использовать в /etc/fstab, чтобы убедиться, что общие ресурсы NFS могут быть установлены автоматически при перезагрузке?**  
Опция `_netdev`, указывающая системе монтировать ресурс только после запуска сетевых интерфейсов, что необходимо для корректного автоматического подключения NFS.
