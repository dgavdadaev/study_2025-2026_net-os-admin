---
## Front matter
title: "Отчёт по лабораторной работе 14"
subtitle: "Настройка файловых служб Samba"
author: "Авдадаев Джамал Геланиевич"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Введение

## Цель работы  

Приобретение навыков настройки доступа групп пользователей к общим ресурсам по протоколу SMB.

## Настройка сервера Samba

Для развертывания Samba-сервера были установлены пакеты Samba, Samba-client и CIFS-utils. После выполнения установки система подтвердила успешное завершение операции и загрузку необходимых зависимостей. Затем была создана группа `sambagroup` с заданным GID 1010, и пользователь `dgavdadaev` был добавлен в эту группу. Также подготовлен каталог, который будет использован в качестве разделяемого ресурса.

![Установка пакетов Samba и подготовка каталога](Screenshot_1.png){ #fig:003 width=80% }

В файле `/etc/samba/smb.conf` был изменён параметр рабочей группы, где вместо стандартного значения использовано имя пользователя. В конце файла добавлен раздел, описывающий общий доступ к каталогу `/srv/sambashare`, содержащий комментарий, путь к ресурсу и группу, которой разрешена запись.

![Редактирование файла smb.conf и добавление ресурса sambashare](Screenshot_2.png){ #fig:004 width=80% }

Служба SMB была запущена и добавлена в автозагрузку. После проверки статуса подтверждено, что демон Samba успешно работает. Для анализа доступных ресурсов был выполнен запрос списка общих каталогов с использованием клиента `smbclient`, что позволило убедиться в наличии созданного ресурса.

![Запуск службы smb и проверка общих ресурсов с помощью smbclient](Screenshot_3.png){ #fig:005 width=80% }

Для ознакомления с правилами межсетевого экрана был просмотрен файл `samba.xml`, содержащий перечень портов и сервисов, необходимых для работы Samba. Определены используемые протоколы и включаемые дополнительные сервисы.

![Файл описания сервиса Samba для firewalld](Screenshot_4.png){ #fig:006 width=80% }

В межсетевой экран были добавлены правила для работы Samba как в текущей сессии, так и на постоянной основе. Затем были настроены права доступа к каталогу: изменена группа владельца и предоставлены соответствующие разрешения. Просмотр контекста SELinux показал изначальное состояние параметров каталога.

Далее был назначен правильный контекст безопасности для совместного использования через Samba, и контекст каталога изменился на `samba_share_t`. Также была активирована возможность экспорта ресурсов Samba на чтение и запись.

![Настройка firewalld, прав доступа и контекста SELinux для каталога sambashare](Screenshot_5.png){ #fig:007 width=80% }

Пользователь `dgavdadaev` проверил свой UID и группы, затем активировал новую группу `sambagroup` в текущей сессии. После этого он смог создать файл в каталоге `/srv/sambashare`, что подтверждает корректность настроек прав доступа и контекста SELinux.

![Создание тестового файла на общем ресурсе от имени пользователя из sambagroup](Screenshot_6.png){ #fig:008 width=80% }

Пользователь `dgavdadaev` был добавлен в локальную базу пользователей Samba. После ввода и подтверждения пароля система подтвердила успешное создание учетной записи Samba.

![Добавление пользователя dgavdadaev в базу пользователей Samba](Screenshot_7.png){ #fig:009 width=80% }

Дополнительно был просмотрен конфигурационный файл `samba-client.xml`, который определяет необходимые параметры для работы клиента Samba, включая используемые порты и включаемые сервисы.

![Файл описания сервиса Samba Client для firewalld](Screenshot_8.png){ #fig:010 width=80% }

## Монтирование файловой системы Samba на клиенте

На клиентской машине были установлены пакеты `samba-client` и `cifs-utils`, необходимые для работы с SMB-ресурсами. Далее был просмотрен файл `samba-client.xml`, описывающий параметры сервиса Samba Client в зоне firewalld. После ознакомления межсетевой экран был настроен на разрешение данного сервиса как временно, так и на постоянной основе.

![Установка пакетов Samba Client и настройка firewalld](Screenshot_9.png){ #fig:011 width=80% }

На клиенте была создана группа `sambagroup` с тем же GID, что и на сервере, и пользователь `dgavdadaev` был добавлен в неё. После этого был изменён параметр рабочей группы в файле `/etc/samba/smb.conf`, чтобы он совпадал с рабочей группой Samba-сервера.

![Настройка smb.conf на клиенте](Screenshot_10.png){ #fig:012 width=80% }

Проверка доступа была выполнена двумя способами:

- вход анонимного пользователя — ресурсы отобразились без указания имени;
- вход под учётной записью `dgavdadaev` — были показаны все доступные ресурсы, включая домашний каталог.

![Просмотр ресурсов через smbclient](Screenshot_11.png){ #fig:013 width=80% }

Для доступа к каталогу на сервере на клиенте была создана точка монтирования `/mnt/samba`. Далее SMB-ресурс был смонтирован с использованием имени пользователя `dgavdadaev` и группы `sambagroup`. После ввода SMB-пароля ресурс стал доступен.

![Монтирование SMB-ресурса вручную](Screenshot_12.png){ #fig:014 width=80% }

Пользователь `dgavdadaev` перешёл в каталог `/mnt/samba` и создал файл `dgavdadaev@client.txt`, что подтверждает корректность настроек прав доступа. Каталог содержит как файл, созданный на сервере, так и файл, созданный локально.

![Создание файла на SMB-ресурсе с клиента](Screenshot_13.png){ #fig:015 width=80% }

Для упрощения аутентификации был создан файл `/etc/samba/smbusers`, содержащий имя пользователя и пароль, доступный только для чтения владельцем.

![Создание файла учётных данных smbusers](Screenshot_14.png){ #fig:016 width=80% }

Затем в файл `/etc/fstab` была добавлена строка для автоматического монтирования SMB-ресурса при загрузке системы. В качестве учётных данных указана ссылка на файл `/etc/samba/smbusers`.

![Добавление записи в fstab](Screenshot_15.png){ #fig:017 width=80% }

После добавления записи ресурс был подключён командой автоматического монтирования, и система корректно обработала конфигурацию.

![Проверка автоматического монтирования](Screenshot_16.png){ #fig:018 width=80% }

После автоматического монтирования ресурса пользователь на сервере создал файл `dgavdadaev@server.txt`. Пользователь на клиенте может видеть оба файла — созданный на сервере и созданный на клиенте, что подтверждает синхронный доступ.

![Проверка содержимого каталога Samba на сервере](Screenshot_17.png){ #fig:019 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальных машин

Для автоматизации настройки Samba на виртуальной машине **server** была создана структура каталогов в директории `/vagrant/provision/server/`. Внутри неё сформирован подкаталог `smb/etc/samba`, в который помещён файл конфигурации Samba (`smb.conf`), скопированный из текущей системы. Это позволит использовать его при автоматическом развёртывании серверной части Samba.

![Создание структуры каталогов и копирование smb.conf на сервере](Screenshot_18.png){ #fig:020 width=80% }

После этого был создан исполняемый файл `smb.sh`, предназначенный для автоматической настройки Samba при поднятии виртуальной машины. Файл был создан, сделан исполняемым и открыт для последующей модификации.

![Содержимое smb.sh для серверной виртуальной машины](Screenshot_20.png){ #fig:022 width=80% }

На виртуальной машине **client** была подготовлена аналогичная структура каталогов `/vagrant/provision/client/smb/etc/samba`. В неё были помещены файлы:

![Создание структуры каталогов и копирование smb.conf и smbusers на клиенте](Screenshot_19.png){ #fig:023 width=80% }

После завершения подготовки конфигурационных файлов и скриптов обе виртуальные машины готовы к автоматизированной настройке Samba при их развёртывании.

![Содержимое скрипта smb.sh на клиенте](Screenshot_21.png){ #fig:025 width=80% }

# Итоги

## Вывод  
В ходе работы был развёрнут файловый сервер Samba на базе Rocky Linux и настроен доступ к разделяемому каталогу. На сервере были сконфигурированы служба `smb`, межсетевой экран и политики SELinux, созданы группа `sambagroup` и пользователь с SMB-учётной записью. На клиентской машине настроен доступ к общему ресурсу как через `smbclient`, так и путём монтирования файловой системы CIFS, в том числе с использованием файла учётных данных и записи в `/etc/fstab`. Дополнительно были подготовлены provisioning-скрипты для автоматической настройки серверной и клиентской виртуальных машин. В результате стенд обеспечивает устойчивый доступ к сетевому ресурсу Samba и может быть быстро развёрнут повторно.

## Контрольные вопросы  

**1. Какова минимальная конфигурация для smb.conf для создания общего ресурса, который предоставляет доступ к каталогу /data?**  
Достаточно указать в `smb.conf` глобальный раздел с рабочей группой и секцию ресурса, в которой задано имя ресурса и путь к каталогу `/data`, а также разрешена запись (например, параметр `read only = no` или аналогичный ему).

**2. Как настроить общий ресурс, который даёт доступ на запись всем пользователям, имеющим права на запись в файловой системе Linux?**  
Нужно сделать ресурс не только для чтения (`read only = no`) и не ограничивать его никакими списками `valid users`, `write list` и т.п. Тогда фактические права будут определяться только правами файловой системы (POSIX-разрешениями и ACL), и любой пользователь с правом записи в каталоге сможет записывать данные через Samba.

**3. Как ограничить доступ на запись к ресурсу только членам определённой группы?**  
Создать в Linux группу, добавить в неё нужных пользователей, назначить эту группу владельцем каталога ресурса и выдать ей права на запись. В `smb.conf` для соответствующей шары указать, что писать могут только члены этой группы, например через параметры `valid users = @groupname` и/или `write list = @groupname` при включённой записи (`read only = no`).

**4. Какой переключатель SELinux нужно использовать, чтобы позволить пользователям получать доступ к домашним каталогам на сервере через SMB?**  
Необходимо включить SELinux-boolean `samba_enable_home_dirs` (обычно командой вида `setsebool -P samba_enable_home_dirs on`), который разрешает доступ Samba к домашним каталогам пользователей.

**5. Как ограничить доступ к определённому ресурсу только узлам из сети 192.168.10.0/24?**  
В секции ресурса (или глобально) в `smb.conf` задать параметр вида `hosts allow = 192.168.10.0/24` (или сокращённо `192.168.10.`). При необходимости остальные сети можно запретить с помощью `hosts deny`.

**6. Какую команду можно использовать, чтобы отобразить список всех пользователей Samba на сервере?**  
Для вывода списка учётных записей Samba обычно используют команду `pdbedit -L` (или `pdbedit -L -v` для подробного вывода).

**7. Что нужно сделать пользователю для доступа к ресурсу, который настроен как многопользовательский ресурс?**  
Пользователь должен пройти аутентификацию со своей SMB-учётной записью: иметь созданного системного пользователя, добавленного в базу Samba, и указать свой логин и пароль при подключении (через `smbclient`, графический клиент или при работе с многопользовательским CIFS-монтированием).

**8. Как установить общий ресурс Samba в качестве многопользовательской учётной записи, где пользователь alice используется как минимальная учётная запись пользователя?**  
В конфигурации ресурса необходимо включить гостевой доступ и указать учётную запись с минимальными правами, например настроить сопоставление гостей и задать гостевую учётную запись `alice`. Тогда все неподтверждённые или анонимные подключения будут выполняться от имени пользователя `alice`, а остальные пользователи смогут аутентифицироваться под своими логинами.

**9. Как можно запретить пользователям просматривать учётные данные монтирования Samba в файле /etc/fstab?**  
Пароль и логин не следует хранить напрямую в `/etc/fstab`. Вместо этого используют отдельный файл с учётными данными (например, `/etc/samba/smbusers` или другой файл с опцией `credentials=`), задают на него права доступа только для `root` (например, режим `600`) и в `fstab` указывают лишь путь к этому файлу.

**10. Какая команда позволяет перечислить все экспортируемые ресурсы Samba, доступные на определённом сервере?**  
Для отображения списка экспортируемых ресурсов Samba на сервере используют команду вида `smbclient -L //server` (при необходимости с указанием имени пользователя), которая выводит перечень всех доступных шар.
