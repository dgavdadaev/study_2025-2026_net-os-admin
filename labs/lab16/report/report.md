---
## Front matter
title: "Отчёт по лабораторной работе 16"
subtitle: "Базовая защита от атак типа «brute force»"
author: "Авдадаев Джамал Геланиевич"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Введение

## Цель работы  

Получить навыки работы с программным средством Fail2ban для обеспечения базовой защиты от атак типа «brute force».

# Процесс работы

## Установка и запуск Fail2ban

### Установка Fail2ban

На сервер был установлен пакет `fail2ban` с помощью менеджера пакетов DNF.  
После завершения установки система вывела сообщение о том, что все необходимые компоненты были успешно добавлены.

![Установка и запуск fail2ban](Screenshot_1.png){ #fig:001 width=80% }

Сервис Fail2ban был запущен и включён в автозагрузку.  
Система создала символьную ссылку в директории `multi-user.target.wants`, подтверждающую успешную активацию сервиса.

### Просмотр журнала Fail2ban

Для проверки работы Fail2ban был открыт журнал событий.  
Записи в логе показывают:

- запуск серверной части Fail2ban;  
- запуск наблюдателя;  
- подключение к базе данных;  
- создание новой базы при первом запуске.

![Просмотр журнала Fail2ban](Screenshot_2.png){ #fig:002 width=80% }

### Создание локального файла конфигурации и включение защиты SSH

Для хранения индивидуальных настроек создан файл в `jail.d`.  
В него добавлены параметры блокировки и включена защита SSH, включая несколько jail-ов для разных типов атак.

![Локальная конфигурация Fail2ban SSH](Screenshot_3.png){ #fig:003 width=80% }

После перезапуска Fail2ban в журнале появились записи о создании и запуске jail-ов:

- `sshd`;  
- `selinux-ssh`;  
- `sshd-ddos`.

Все jail-ы корректно активировались и начали обработку данных журналов.

![Создание и запуск jail-ов SSH](Screenshot_4.png){ #fig:004 width=80% }

### Включение защиты HTTP-сервисов

В локальный файл конфигурации были добавлены HTTP-jail-ы для защиты Apache от различных типов атак.

![Включение HTTP-jail-ов](Screenshot_5.png){ #fig:005 width=80% }

После перезапуска Fail2ban журнал показал инициализацию каждого HTTP-jail-а, добавление их лог-файлов и успешный запуск.

![Работа HTTP-jail-ов](Screenshot_6.png){ #fig:006 width=80% }

### Включение защиты почтовых сервисов

В локальной конфигурации были включены jail-ы для защиты почтовых сервисов: Postfix, Dovecot и других.

![Включение защиты почтовых сервисов](Screenshot_7.png){ #fig:007 width=80% }

После очередного перезапуска Fail2ban были созданы и запущены дополнительные jail-ы, что видно в логе:

- защита Postfix;  
- защита SASL;  
- защита Dovecot;  
- активация RBL-фильтрации.

![Работа почтовых jail-ов](Screenshot_8.png){ #fig:008 width=80% }

## Проверка работы Fail2ban

Для проверки работоспособности Fail2ban был просмотрен общий статус сервиса.  
В выводе отображается количество активных jail-ов и их список.

![Общий статус Fail2ban](Screenshot_9.png){ #fig:009 width=80% }

Был просмотрен статус jail-а `sshd`, где отображаются:

- количество неудачных попыток входа;
- количество заблокированных IP-адресов;
- список заблокированных адресов.

![Статус защиты SSH](Screenshot_10.png){ #fig:010 width=80% }

Для усиления защиты была установлена величина максимального количества ошибок при попытке входа:

![Установка maxretry](Screenshot_9.png){ #fig:011 width=80% }

После нескольких неудачных попыток входа с клиента Fail2ban заблокировал адрес, что подтверждается обновлённым статусом jail-а.

![Блокировка IP после неудачных попыток входа](Screenshot_10.png){ #fig:012 width=80% }

IP-адрес клиента был успешно разблокирован с помощью соответствующей команды.  
После выполнения команды статус jail-а обновился, и количество текущих блокировок стало равно нулю.

![Разблокировка адреса клиента](Screenshot_10.png){ #fig:013 width=80% }

В локальную конфигурацию Fail2ban было добавлено исключение, запрещающее блокировать определённый IP-адрес.  
Изменение внесено в раздел `[DEFAULT]` файла локальной конфигурации.

![Добавление ignoreip](Screenshot_11.png){ #fig:014 width=80% }

После перезапуска Fail2ban в журнале появилось подтверждение, что указанный IP теперь игнорируется.

![Fail2ban игнорирует IP-адрес клиента](Screenshot_12.png){ #fig:015 width=80% }


После внесения IP в `ignoreip` повторная попытка входа с неправильным паролем не привела к блокировке, что подтверждается отсутствием записей о бане в статусе jail-а `sshd`.


## Внесение изменений во внутреннее окружение виртуальной машины

На виртуальной машине были созданы каталоги для хранения кастомных конфигураций Fail2ban, которые используются при provisioning’е Vagrant.

![Создание каталогов и копирование конфигурации](Screenshot_13.png){ #fig:016 width=80% }

В каталоге `/vagrant/provision/server` был создан исполняемый файл `protect.sh`, содержащий:

- установку Fail2ban;
- копирование заранее подготовленных конфигураций;
- восстановление контекстов SELinux;
- запуск и включение Fail2ban в автозагрузку.

![Скрипт protect.sh](Screenshot_14.png){ #fig:017 width=80% }

# Итоги

## Вывод  
Fail2ban обеспечивает автоматическую защиту сервера, анализируя журналы и блокируя источники подозрительной активности. В ходе работы были настроены jail-ы для SSH, веб- и почтовых служб, проверена блокировка и разблокировка IP, добавлены исключения, а также подготовлен provisioning-скрипт для автоматизации конфигурации. Система функционирует корректно и эффективно повышает безопасность сервера.

## Контрольные вопросы

**1. Поясните принцип работы Fail2ban.**
Fail2ban анализирует журналы системных сервисов и отслеживает повторяющиеся ошибки (например, неудачные попытки входа).
При превышении установленного лимита программа динамически добавляет правила в брандмауэр и блокирует IP-адрес нарушителя на заданное время.

**2. Настройки какого файла более приоритетны: jail.conf или jail.local?**
Наиболее приоритетны настройки **jail.local** — именно этот файл предназначен для переопределения значений по умолчанию, указанных в *jail.conf*.

**3. Как настроить оповещение администратора при срабатывании Fail2ban?**
В секции действий Fail2ban можно указать отправку email-сообщений.
Для этого выбирают action, поддерживающий уведомления, например:

* `action = %(action_mwl)s`

Также необходимо корректно настроить локальную почтовую систему, чтобы Fail2ban мог отправлять письма.

**4. Поясните построчно настройки по умолчанию в конфигурационном файле `/etc/fail2ban/jail.conf`, относящиеся к веб-службе.**
Основные параметры для веб-служб включают:

* указание соответствующих фильтров для Apache/Nginx;
* выбор лог-файлов, которые должны анализироваться;
* активацию или деактивацию нужных jail-ов;
* настройку временных интервалов (findtime, bantime);
* определение лимита ошибок (maxretry).

Эти параметры задают общие правила мониторинга веб-сервера и его реакцию на подозрительные запросы.

**5. Поясните построчно настройки по умолчанию в конфигурационном файле `/etc/fail2ban/jail.conf`, относящиеся к почтовой службе.**
Стандартные секции для почтовых служб включают:

* выбор фильтра (например, postfix, dovecot);
* включение или отключение конкретного jail-а;
* указание логов почтовых сервисов;
* определение временных интервалов и числа попыток;
* выбор действий при обнаружении попыток взлома.

Эти настройки позволяют контролировать работу SMTP/IMAP/POP сервисов и блокировать попытки подбора паролей.

**6. Какие действия может выполнять Fail2ban при обнаружении атакующего IP-адреса?
Где посмотреть описание действий?**
Fail2ban может:

* блокировать IP через firewall;
* отправлять уведомления администратору;
* выполнять пользовательские скрипты;
* объединять несколько действий в один сценарий.

Описание действий находится в директории:

* `/etc/fail2ban/action.d/`

Каждый файл описывает конкретное действие и может использоваться в настройках jail-ов.

**7. Как получить список действующих правил Fail2ban?**
Получить список активных jail-ов можно с помощью:

* `fail2ban-client status`

Этот вывод включает общее количество jail-ов и их названия.

**8. Как получить статистику заблокированных Fail2ban адресов?**
Используют команду:

* `fail2ban-client status <jail>`

Она показывает:

* число текущих блокировок;
* общее количество заблокированных IP;
* список заблокированных адресов.

**9. Как разблокировать IP-адрес?**
Для снятия блокировки выполняется команда:

* `fail2ban-client set <jail> unbanip <IP>`

Она удаляет IP из списка заблокированных и снимает правило из брандмауэра.
